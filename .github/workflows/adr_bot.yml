name: ADR Bot

on:
  issues:
    types: [opened, labeled, edited]
  discussion_comment:
    types: [created]
  discussion:
    types: [closed]

permissions:
  contents: write
  discussions: write

jobs:
  # Job 1: D√©tecter les issues qui n√©cessitent un ADR et cr√©er une discussion
  detect_and_create_discussion:
    name: Detect ADR need and create discussion
    runs-on: ubuntu-latest
    if: github.event_name == 'issues' && (github.event.action == 'opened' || github.event.action == 'labeled')
    
    permissions:
      issues: write
      discussions: write
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Check if already has discussion
        id: check_existing
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            
            // V√©rifier si une discussion existe d√©j√† pour cette issue
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number
            });
            
            const hasDiscussion = comments.data.some(c => 
              c.user.type === 'Bot' && 
              c.body.includes('üèõÔ∏è **ADR Discussion Created**')
            );
            
            return !hasDiscussion;
      
      - name: Analyze if ADR is needed
        if: fromJSON(steps.check_existing.outputs.result)
        id: analyze
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            
            // Crit√®res de d√©tection d'un ADR
            const hasADRLabel = issue.labels.some(l => 
              ['adr', 'architecture', 'design-decision'].includes(l.name.toLowerCase())
            );
            
            const adrKeywords = [
              'architecture', 'architectural', 'design decision',
              'adr', 'technical decision', 'system design',
              'refactor', 'redesign', 'architectural choice'
            ];
            
            const titleLower = issue.title.toLowerCase();
            const bodyLower = (issue.body || '').toLowerCase();
            
            const hasKeywords = adrKeywords.some(kw => 
              titleLower.includes(kw) || bodyLower.includes(kw)
            );
            
            const isADR = hasADRLabel || hasKeywords;
            
            console.log(`Issue #${issue.number}: ADR detection = ${isADR}`);
            console.log(`  - Has ADR label: ${hasADRLabel}`);
            console.log(`  - Has keywords: ${hasKeywords}`);
            
            return {
              isADR: isADR,
              issueNumber: issue.number,
              issueTitle: issue.title,
              issueBody: issue.body || ''
            };
      
      - name: Get discussion category ID
        if: fromJSON(steps.check_existing.outputs.result) && fromJSON(steps.analyze.outputs.result).isADR
        id: get_category
        uses: actions/github-script@v7
        with:
          script: |
            // R√©cup√©rer toutes les cat√©gories de discussion
            const result = await github.graphql(`
              query($owner: String!, $repo: String!) {
                repository(owner: $owner, name: $repo) {
                  discussionCategories(first: 20) {
                    nodes {
                      id
                      name
                    }
                  }
                }
              }
            `, {
              owner: context.repo.owner,
              repo: context.repo.repo
            });
            
            const categories = result.repository.discussionCategories.nodes;
            
            console.log('üìã Available discussion categories:');
            categories.forEach(cat => {
              console.log(`  - ${cat.name}: ${cat.id}`);
            });
            
            // Chercher la cat√©gorie "Architecture Decisions" (ou variantes)
            const possibleNames = [
              'Architecture Decisions',
              'Architecture Decision Records',
              'ADR',
              'Architectural Decisions',
              'architecture decisions',
              'adr'
            ];
            
            let category = categories.find(cat => 
              possibleNames.some(name => 
                cat.name.toLowerCase() === name.toLowerCase()
              )
            );
            
            // Si pas trouv√©e, utiliser la premi√®re cat√©gorie disponible
            if (!category && categories.length > 0) {
              category = categories[0];
              console.log(`‚ö†Ô∏è  No "Architecture Decisions" category found, using: ${category.name}`);
            }
            
            if (!category) {
              throw new Error('No discussion categories found! Please create at least one discussion category in your repository.');
            }
            
            console.log(`‚úÖ Using category: ${category.name} (${category.id})`);
            
            return {
              categoryId: category.id,
              categoryName: category.name
            };
      
      - name: Create ADR discussion
        if: fromJSON(steps.check_existing.outputs.result) && fromJSON(steps.analyze.outputs.result).isADR
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const analysis = ${{ steps.analyze.outputs.result }};
            const category = ${{ steps.get_category.outputs.result }};
            
            const discussionBody = `
            # üèõÔ∏è Architecture Decision Record Discussion
            
            **Related Issue**: #${analysis.issueNumber}
            **Status**: üü° Under Discussion
            
            ---
            
            ## üìã Original Issue Context
            
            ${analysis.issueBody}
            
            ---
            
            ## üìù How to fill this ADR
            
            Use the following commands to fill in the ADR sections:
            
            - \`/adr fill <section>\` - Fill or replace a section with content
            - \`/adr append <section>\` - Add content to an existing section
            - \`/adr show\` - Display the current state of the ADR
            - \`/adr show <section>\` - Display a specific section
            - \`/adr approve\` - Approve and generate the ADR document (maintainers only)
            - \`/adr reject\` - Reject this ADR (maintainers only)
            
            ### Example:
            
            \`\`\`
            /adr fill context
            We need to choose a database solution for our new microservices architecture.
            Currently using a monolithic PostgreSQL database which is becoming a bottleneck.
            Requirements: high availability, horizontal scalability, multi-region support.
            \`\`\`
            
            ---
            
            ## üìã Required Sections
            
            - **Context**: What is the problem or decision we need to make?
            - **Decision**: What solution are we proposing?
            - **Consequences**: What are the impacts (positive and negative)?
            
            ## üìã Optional Sections
            
            - **Alternatives**: What other options were considered?
            - **SafetyImpact**: Safety-related considerations (if applicable)
            - **Implementation**: How will this be implemented?
            
            ---
            
            ## üë• Participants
            
            Tag relevant stakeholders for review.
            `;
            
            try {
              console.log(`Creating discussion in category: ${category.categoryName}`);
              
              const result = await github